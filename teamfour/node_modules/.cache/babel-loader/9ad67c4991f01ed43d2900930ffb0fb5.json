{"ast":null,"code":"'use strict';\n\nvar handleTimestampOption = require('../schema/handleTimestampOption');\n\nmodule.exports = applyTimestampsToChildren;\n/*!\n * ignore\n */\n\nfunction applyTimestampsToChildren(now, update, schema) {\n  if (update == null) {\n    return;\n  }\n\n  var keys = Object.keys(update);\n  var key;\n  var len;\n  var createdAt;\n  var updatedAt;\n  var timestamps;\n  var path;\n  var hasDollarKey = keys.length && keys[0].charAt(0) === '$';\n\n  if (hasDollarKey) {\n    if (update.$push) {\n      for (key in update.$push) {\n        var $path = schema.path(key);\n\n        if (update.$push[key] && $path && $path.$isMongooseDocumentArray && $path.schema.options.timestamps) {\n          timestamps = $path.schema.options.timestamps;\n          createdAt = handleTimestampOption(timestamps, 'createdAt');\n          updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n          if (update.$push[key].$each) {\n            update.$push[key].$each.forEach(function (subdoc) {\n              if (updatedAt != null) {\n                subdoc[updatedAt] = now;\n              }\n\n              if (createdAt != null) {\n                subdoc[createdAt] = now;\n              }\n            });\n          } else {\n            if (updatedAt != null) {\n              update.$push[key][updatedAt] = now;\n            }\n\n            if (createdAt != null) {\n              update.$push[key][createdAt] = now;\n            }\n          }\n        }\n      }\n    }\n\n    if (update.$set != null) {\n      var _keys = Object.keys(update.$set);\n\n      for (var _i = 0; _i < _keys.length; _i++) {\n        key = _keys[_i];\n        // Replace positional operator `$` and array filters `$[]` and `$[.*]`\n        var keyToSearch = key.replace(/\\.\\$(\\[[^\\]]*\\])?\\./g, '.0.').replace(/\\.(\\[[^\\]]*\\])?\\$$/, '.0');\n        path = schema.path(keyToSearch);\n\n        if (!path) {\n          continue;\n        }\n\n        if (Array.isArray(update.$set[key]) && path.$isMongooseDocumentArray) {\n          len = update.$set[key].length;\n          timestamps = path.schema.options.timestamps;\n\n          if (timestamps) {\n            createdAt = handleTimestampOption(timestamps, 'createdAt');\n            updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n            for (var i = 0; i < len; ++i) {\n              if (updatedAt != null) {\n                update.$set[key][i][updatedAt] = now;\n              }\n\n              if (createdAt != null) {\n                update.$set[key][i][createdAt] = now;\n              }\n            }\n          }\n        } else if (update.$set[key] && path.$isSingleNested) {\n          timestamps = path.schema.options.timestamps;\n\n          if (timestamps) {\n            createdAt = handleTimestampOption(timestamps, 'createdAt');\n            updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n            if (updatedAt != null) {\n              update.$set[key][updatedAt] = now;\n            }\n\n            if (createdAt != null) {\n              update.$set[key][createdAt] = now;\n            }\n          }\n        } else if (path.$parentSchema !== schema && path.$parentSchema != null) {\n          var parentPath = path.$parentSchema.$schemaType;\n\n          if (parentPath == null) {\n            continue;\n          }\n\n          timestamps = parentPath.schema.options.timestamps;\n          createdAt = handleTimestampOption(timestamps, 'createdAt');\n          updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n          if (updatedAt == null) {\n            continue;\n          }\n\n          if (parentPath.$isSingleNested) {\n            // Single nested is easy\n            update.$set[parentPath.path + '.' + updatedAt] = now;\n            continue;\n          }\n\n          var childPath = key.substr(parentPath.path.length + 1);\n          var firstDot = childPath.indexOf('.'); // Shouldn't happen, but if it does ignore this path\n\n          if (firstDot === -1) {\n            continue;\n          }\n\n          childPath = childPath.substr(0, firstDot);\n          update.$set[parentPath.path + '.' + childPath + '.' + updatedAt] = now;\n        } else if (path.schema != null && path.schema != schema) {\n          timestamps = path.schema.options.timestamps;\n          createdAt = handleTimestampOption(timestamps, 'createdAt');\n          updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n          if (updatedAt != null) {\n            update.$set[key][updatedAt] = now;\n          }\n\n          if (createdAt != null) {\n            update.$set[key][createdAt] = now;\n          }\n        }\n      }\n    }\n  }\n}","map":null,"metadata":{},"sourceType":"script"}